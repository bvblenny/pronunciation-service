<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pronunciation Service • Demo Console</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2/css/pico.min.css">
  <style>
    :root { --ok: #17a34a; --warn: #f59e0b; --err: #dc2626; --muted: #6b7280; }
    header { margin-block: 1rem 0; }
    .grid { align-items: start; }
    .kpi { display:flex; gap:.5rem; align-items:baseline; }
    .kpi .value { font-size:1.4rem; font-weight:700; }
    .kpi .label { color: var(--muted); font-size:.9rem; }
    .badge { display:inline-block; padding:.15rem .5rem; border-radius:999px; font-size:.75rem; font-weight:600; }
    .match { background:#e8f5e9; color:#1b5e20; }
    .sub { background:#fff7ed; color:#9a3412; }
    .ins { background:#eef2ff; color:#1e3a8a; }
    .del { background:#fee2e2; color:#991b1b; }
    .muted { color: var(--muted); }
    .toolbar { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    .hidden { display:none !important; }
    .progress { height:8px; margin:.25rem 0 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    table tbody tr td { vertical-align: top; }
    .nowrap { white-space: nowrap; }
    .center { text-align:center; }
    .right { text-align:right; }
  </style>
</head>
<body>
  <main class="container">
    <header>
      <h1>Pronunciation Service</h1>
    </header>

    <!-- Health -->
    <section>
      <article>
        <header class="toolbar">
          <h2>Health</h2>
          <button id="btnHealth" class="secondary">Check</button>
          <small id="healthStatus" class="muted">Service status unknown</small>
        </header>
        <div id="healthDetails" class="muted"></div>
      </article>
    </section>

    <!-- Input -->
    <section>
      <article>
        <header><h2>Input</h2></header>
        <label>
          Reference text
          <textarea id="referenceText" rows="2" placeholder="Type the text you want to pronounce...">Hello world</textarea>
        </label>
        <div class="grid">
          <label>
            Language code
            <input id="languageCode" type="text" value="en-US" placeholder="e.g. en-US, de-DE" />
          </label>
          <label>
            Min pause (sec)
            <input id="minPause" type="number" step="0.1" min="0" value="0.2" />
            <small class="muted">Client-side filter for pause display only</small>
          </label>
        </div>
      </article>
    </section>

    <!-- Capture & Upload -->
    <section>
      <div class="grid">
        <article>
          <header class="toolbar">
            <h3>Record</h3>
            <button id="btnStart">Start</button>
            <button id="btnStop" class="secondary" disabled>Stop</button>
            <small id="recStatus" class="muted">Idle</small>
          </header>
          <progress id="recLevel" class="progress" value="0" max="1"></progress>
          <div id="playback" class="toolbar hidden">
            <audio id="audio" controls></audio>
            <button id="btnSubmitRecording" class="contrast">Analyze recording</button>
            <button id="btnDiscard" class="secondary">Discard</button>
          </div>
        </article>
        <article>
          <header><h3>Upload</h3></header>
          <label>
            Audio file
            <input id="fileInput" type="file" accept="audio/*" />
          </label>
          <div class="toolbar">
            <button id="btnSubmitFile" class="contrast">Analyze file</button>
            <small id="fileInfo" class="muted">Select a WAV/PCM if possible for best results</small>
          </div>
        </article>
      </div>
    </section>

    <!-- Results -->
    <section id="resultsSection" class="hidden">
      <article>
        <header class="toolbar">
          <h2>Results</h2>
          <small id="resultHint" class="muted">Latest analysis</small>
        </header>

        <div class="grid">
          <div>
            <div class="kpi"><span class="label">WER</span><span id="kWer" class="value">–</span></div>
            <div class="kpi"><span class="label">Substitutions</span><span id="kSub" class="value">–</span></div>
          </div>
          <div>
            <div class="kpi"><span class="label">Insertions</span><span id="kIns" class="value">–</span></div>
            <div class="kpi"><span class="label">Deletions</span><span id="kDel" class="value">–</span></div>
          </div>
          <div>
            <div class="kpi"><span class="label">Duration</span><span id="kDur" class="value">–</span></div>
            <div class="kpi"><span class="label">WPM</span><span id="kWpm" class="value">–</span></div>
          </div>
          <div>
            <div class="kpi"><span class="label">Avg. word</span><span id="kAvg" class="value">–</span></div>
            <div class="kpi"><span class="label">Words</span><span id="kCount" class="value">–</span></div>
          </div>
        </div>

        <details open>
          <summary>Overview</summary>
          <p class="mono"><strong>Reference:</strong> <span id="refOut"></span></p>
          <p class="mono"><strong>Transcript:</strong> <span id="hypOut"></span></p>
        </details>

        <details open>
          <summary>Word analysis</summary>
          <div class="overflow-auto">
            <table>
              <thead>
                <tr>
                  <th class="right nowrap">#</th>
                  <th>Expected</th>
                  <th>Actual</th>
                  <th>Type</th>
                  <th class="right nowrap">Start (s)</th>
                  <th class="right nowrap">End (s)</th>
                  <th class="right nowrap">Dur (s)</th>
                  <th class="right nowrap">Eval</th>
                </tr>
              </thead>
              <tbody id="wordsTbody"></tbody>
            </table>
          </div>
        </details>

        <details>
          <summary>Pauses</summary>
          <div class="overflow-auto">
            <table>
              <thead>
                <tr>
                  <th class="right nowrap">Start (s)</th>
                  <th class="right nowrap">End (s)</th>
                  <th class="right nowrap">Duration (s)</th>
                  <th>Between</th>
                </tr>
              </thead>
              <tbody id="pausesTbody"></tbody>
            </table>
          </div>
        </details>
      </article>
    </section>
  </main>

  <template id="rowWordTpl">
    <tr>
      <td class="right"></td>
      <td class="mono"></td>
      <td class="mono"></td>
      <td><span class="badge"></span></td>
      <td class="right"></td>
      <td class="right"></td>
      <td class="right"></td>
      <td class="right"></td>
    </tr>
  </template>
  <template id="rowPauseTpl">
    <tr>
      <td class="right"></td>
      <td class="right"></td>
      <td class="right"></td>
      <td class="mono"></td>
    </tr>
  </template>

  <script>
    // --- Utilities ---
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const fmt = (n, d=2) => (n ?? null) === null ? '–' : Number(n).toFixed(d);
    const pct = (n, d=1) => (n ?? null) === null ? '–' : (Number(n) * 100).toFixed(d) + '%';

    function setLoading(button, loading) {
      if (!button) return;
      if (loading) {
        button.setAttribute('aria-busy', 'true');
        button.disabled = true;
      } else {
        button.removeAttribute('aria-busy');
        button.disabled = false;
      }
    }

    function badgeFor(type) {
      const span = document.createElement('span');
      span.className = 'badge ' + ({
        MATCH: 'match', SUBSTITUTION: 'sub', INSERTION: 'ins', DELETION: 'del'
      }[type] || '');
      span.textContent = type;
      return span;
    }

    function blobDuration(blob) {
      // Best-effort: create audio element and compute metadata duration
      return new Promise(resolve => {
        const audio = new Audio(URL.createObjectURL(blob));
        audio.addEventListener('loadedmetadata', () => resolve(audio.duration || null));
        audio.addEventListener('error', () => resolve(null));
      });
    }

    // --- Health ---
    $('#btnHealth').addEventListener('click', async () => {
      const btn = $('#btnHealth');
      setLoading(btn, true);
      try {
        const resp = await fetch('/api/pronunciation/health');
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        $('#healthStatus').textContent = `Service: ${data.status || 'UNKNOWN'}`;
        $('#healthStatus').style.color = data.status === 'UP' ? 'var(--ok)' : 'var(--warn)';
        $('#healthDetails').textContent = `Name: ${data.service || 'n/a'}`;
      } catch (e) {
        $('#healthStatus').textContent = 'Service: DOWN';
        $('#healthStatus').style.color = 'var(--err)';
        $('#healthDetails').textContent = 'Could not reach backend.';
      } finally {
        setLoading(btn, false);
      }
    });

    // --- Recording ---
    let mediaRecorder, recChunks = [], recStream, levelTimer;

    async function startRecording() {
      $('#recStatus').textContent = 'Requesting microphone…';
      try {
        recStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch (e) {
        $('#recStatus').textContent = 'Microphone permission denied';
        return;
      }

      recChunks = [];
      mediaRecorder = new MediaRecorder(recStream);
      mediaRecorder.ondataavailable = (e) => recChunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const blob = new Blob(recChunks, { type: 'audio/webm' });
        $('#audio').src = URL.createObjectURL(blob);
        $('#playback').classList.remove('hidden');
        $('#recStatus').textContent = 'Recorded';
        stopLevelMeter();
        recStream.getTracks().forEach(t => t.stop());
      };

      mediaRecorder.start();
      $('#recStatus').textContent = 'Recording…';
      $('#btnStart').disabled = true;
      $('#btnStop').disabled = false;
      startLevelMeter(recStream);
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
      $('#btnStart').disabled = false;
      $('#btnStop').disabled = true;
    }

    function discardRecording() {
      $('#audio').removeAttribute('src');
      $('#playback').classList.add('hidden');
      recChunks = [];
      $('#recStatus').textContent = 'Idle';
    }

    function startLevelMeter(stream) {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const source = ctx.createMediaStreamSource(stream);
      const analyser = ctx.createAnalyser();
      analyser.fftSize = 256;
      source.connect(analyser);
      const dataArray = new Uint8Array(analyser.frequencyBinCount);
      function tick() {
        analyser.getByteTimeDomainData(dataArray);
        let sum = 0;
        for (let i=0;i<dataArray.length;i++) { const v=(dataArray[i]-128)/128; sum += v*v; }
        const rms = Math.sqrt(sum / dataArray.length);
        $('#recLevel').value = Math.min(1, rms * 3);
      }
      levelTimer = setInterval(tick, 100);
    }
    function stopLevelMeter() { clearInterval(levelTimer); $('#recLevel').value = 0; }

    $('#btnStart').addEventListener('click', startRecording);
    $('#btnStop').addEventListener('click', stopRecording);
    $('#btnDiscard').addEventListener('click', discardRecording);

    // --- Submit helpers ---
    async function analyzeBlob(audioBlob) {
      const ref = $('#referenceText').value.trim();
      if (!ref) { alert('Please enter a reference text.'); return; }
      const lang = $('#languageCode').value.trim() || 'en-US';

      const btns = $$('.contrast'); btns.forEach(b => setLoading(b, true));
      $('#resultHint').textContent = 'Analyzing…';

      const form = new FormData();
      form.append('audio', audioBlob);
      form.append('referenceText', ref);
      form.append('languageCode', lang);

      try {
        const resp = await fetch('/api/pronunciation/analyze-detailed', { method: 'POST', body: form });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        renderResults(data);
        $('#resultsSection').classList.remove('hidden');
        $('#resultHint').textContent = 'Done';
        window.scrollTo({ top: $('#resultsSection').offsetTop - 12, behavior: 'smooth' });
      } catch (e) {
        alert('Analysis failed: ' + (e?.message || e));
      } finally {
        btns.forEach(b => setLoading(b, false));
      }
    }

    $('#btnSubmitRecording').addEventListener('click', async () => {
      if (!recChunks.length) { alert('Please record first.'); return; }
      const blob = new Blob(recChunks, { type: 'audio/webm' });
      await analyzeBlob(blob);
    });

    $('#btnSubmitFile').addEventListener('click', async () => {
      const f = $('#fileInput').files?.[0];
      if (!f) { alert('Please select an audio file.'); return; }
      $('#fileInfo').textContent = `${f.name} • ${(f.size/1024/1024).toFixed(2)} MB`;
      await analyzeBlob(f);
    });

    // --- Render ---
    function renderResults(d) {
      // KPIs
      $('#kWer').textContent = pct(d.wer);
      $('#kSub').textContent = d.substitutions;
      $('#kIns').textContent = d.insertions;
      $('#kDel').textContent = d.deletions;
      $('#kDur').textContent = d.totalDurationSec != null ? fmt(d.totalDurationSec, 2) + 's' : '–';
      $('#kWpm').textContent = d.speechRateWpm != null ? fmt(d.speechRateWpm, 1) : '–';
      $('#kAvg').textContent = d.averageWordDurationSec != null ? fmt(d.averageWordDurationSec, 2) + 's' : '–';
      $('#kCount').textContent = d.words?.length ?? 0;

      // Texts
      $('#refOut').textContent = d.referenceText || '';
      $('#hypOut').textContent = (d.transcript || '').trim();

      // Words table
      const tbody = $('#wordsTbody');
      tbody.innerHTML = '';
      (d.words || []).forEach(w => {
        const row = $('#rowWordTpl').content.firstElementChild.cloneNode(true);
        const cells = row.children;
        cells[0].textContent = w.index;
        cells[1].textContent = w.expected ?? '';
        cells[2].textContent = w.actual ?? '';
        const b = badgeFor(w.errorType);
        cells[3].innerHTML = ''; cells[3].appendChild(b);
        cells[4].textContent = w.startTimeSec != null ? fmt(w.startTimeSec, 2) : '–';
        cells[5].textContent = w.endTimeSec != null ? fmt(w.endTimeSec, 2) : '–';
        cells[6].textContent = w.durationSec != null ? fmt(w.durationSec, 2) : '–';
        cells[7].textContent = w.evaluation != null ? fmt(w.evaluation, 2) : '–';
        tbody.appendChild(row);
      });

      // Pauses table (client-side min filter)
      const pbody = $('#pausesTbody');
      pbody.innerHTML = '';
      const minPause = Number($('#minPause').value) || 0;
      (d.pauses || []).filter(p => p.durationSec >= minPause).forEach(p => {
        const row = $('#rowPauseTpl').content.firstElementChild.cloneNode(true);
        const cells = row.children;
        cells[0].textContent = fmt(p.startTimeSec, 2);
        cells[1].textContent = fmt(p.endTimeSec, 2);
        cells[2].textContent = fmt(p.durationSec, 2);
        cells[3].textContent = `${p.precedingWord || ''} → ${p.followingWord || ''}`;
        pbody.appendChild(row);
      });
    }
  </script>
</body>
</html>
